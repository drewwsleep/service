let services={},parts={};function loadCatalog(){return console.log("Загружаю каталог с сервера..."),fetch("/api/items").then(e=>{if(e.ok)return e.json();throw new Error("Ошибка загрузки: "+e.status)}).then(e=>(console.log("Каталог загружен:",e),e)).catch(e=>(console.error("Ошибка при загрузке каталога:",e),{services:[],parts:[]}))}let allServices=[],allParts=[];function applyCatalogData(e){e&&(allServices=e.services||[],allParts=e.parts||[],filterAndRender())}function filterAndRender(){let t=document.getElementById("searchInput")?.value.trim().toLowerCase()||"";var e=document.getElementById("typeFilter")?.value||"all";let n=parseFloat(document.getElementById("priceFrom")?.value)||0,a=parseFloat(document.getElementById("priceTo")?.value)||1/0,r=allServices,o=allParts;t&&(r=r.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)),o=o.filter(e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t))),r=r.filter(e=>e.price>=n&&e.price<=a),o=o.filter(e=>e.price>=n&&e.price<=a),"service"===e?(renderServices(r),renderParts([])):(renderServices("part"===e?[]:r),renderParts(o))}function calculatePrice(e,t){return(t&&e.pricingRules?.engineVolume?e.pricingRules.engineVolume.find(e=>t<=e.upTo)||e.pricingRules.engineVolume.slice(-1)[0]:e).price}function renderServices(e){let r=document.querySelector(".services-grid");r&&(r.innerHTML="",e.length?(e.forEach(e=>{var t=document.createElement("article"),n=(t.className="service-card",JSON.parse(localStorage.getItem("currentUser"))),n=calculatePrice(e,n?.car?.engineVolume),a=e.parts&&0<e.parts.length?`<p><strong>Включает:</strong></p>
         <ul>${e.parts.map(e=>`<li>${e}</li>`).join("")}</ul>`:"";t.innerHTML=`
      <h3>${e.name}</h3>
      <p class="price">${n} ₽</p>
      <p class="desc">${e.description}</p>
      <div class="service-parts">${a}</div>
      <button class="btn-select-service" data-service="${e.name}">Выбрать</button>
    `,r.appendChild(t)}),document.querySelectorAll(".btn-select-service").forEach(e=>{e.addEventListener("click",handleSelectService)})):r.innerHTML='<p class="empty-message">Услуги не загружены</p>')}function handleSelectService(e){e.preventDefault();var e=this.dataset.service,t=document.getElementById("selectedService");t&&(t.value=e)}function renderParts(e){let r=document.querySelector(".parts-grid");r&&(r.innerHTML="",e.length?e.forEach(e=>{var t=document.createElement("article"),n=(t.className="part-card",JSON.parse(localStorage.getItem("currentUser"))),n=calculatePrice(e,n?.car?.engineVolume),a=e.image?`<div class="part-image"><img src="${e.image}" alt="${e.name}" onerror="this.parentElement.style.display='none'"></div>`:"";t.innerHTML=`
      ${a}
      <h3>${e.name}</h3>
      <p class="price">${n} ₽</p>
      <p class="desc">${e.description}</p>
      <button class="btn-to-cart" data-part="${e.name}">В корзину</button>
    `,r.appendChild(t)}):r.innerHTML='<p class="empty-message">Запчасти не загружены</p>')}function loadRecords(){return fetch("/api/records").then(e=>e.json()).catch(()=>[])}function deleteRecordFromServer(e){return fetch("/api/records/"+e,{method:"DELETE"})}function clearAllRecords(){return fetch("/api/records",{method:"DELETE"})}function submitBooking(e){return fetch("/api/booking",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}async function displayUpcomingBookings(){try{var e=await loadRecords();let t=new Date;t.setHours(0,0,0,0);var n=e.filter(e=>new Date(e.date)>=t).sort((e,t)=>new Date(e.date)-new Date(t.date)).slice(0,5),a=document.getElementById("upcomingBookings");a&&(0===n.length?a.innerHTML='<p class="empty-message">Нет предстоящих записей</p>':a.innerHTML=n.map(e=>`
      <div class="booking-item">
        <div class="booking-info">
          <h4>${e.clientName}</h4>
          <p><strong>Услуга:</strong> ${e.service}</p>
          <p><strong>Дата:</strong> ${new Date(e.date).toLocaleDateString("ru-RU")} ${e.time}</p>
          <p><strong>Автомобиль:</strong> ${e.carModel}</p>
          <p><strong>Стоимость:</strong> ${e.total} ₽</p>
        </div>
      </div>
    `).join(""))}catch(e){console.error("Ошибка загрузки записей:",e)}}async function updateAdmin(){try{var e=await loadRecords(),n=document.getElementById("adminRecordsList");if(n){0===e.length?n.innerHTML='<p class="empty-message">Записей нет</p>':(n.innerHTML=e.map((e,t)=>`
        <div class="admin-record-item">
          <div class="record-header">
            <span class="record-number">#${t+1}</span>
            <button class="btn-delete-record" data-id="${e.id}">Удалить</button>
          </div>
          <div class="record-details">
            <p><strong>Имя:</strong> ${e.clientName}</p>
            <p><strong>Телефон:</strong> ${e.clientPhone}</p>
            <p><strong>Email:</strong> ${e.clientEmail}</p>
            <p><strong>Авто:</strong> ${e.carModel}</p>
            <p><strong>Услуга:</strong> ${e.service}</p>
            <p><strong>Дата:</strong> ${e.date} ${e.time}</p>
            <p><strong>Стоимость:</strong> ${e.total} ₽</p>
          </div>
        </div>
      `).join(""),document.querySelectorAll(".btn-delete-record").forEach(e=>{e.addEventListener("click",async()=>{await deleteRecordFromServer(e.dataset.id),updateAdmin(),displayUpcomingBookings()})}));var a=document.getElementById("totalRecords");a&&(a.textContent=e.length);let t=(new Date).toISOString().split("T")[0];var r=e.filter(e=>e.date===t).length,o=document.getElementById("todayRecords"),i=(o&&(o.textContent=r),e.reduce((e,t)=>e+(t.total||0),0)),s=document.getElementById("totalRevenue");s&&(s.textContent=i+" ₽")}}catch(e){console.error("Ошибка обновления админки:",e)}}document.addEventListener("DOMContentLoaded",async function(){let d=document.getElementById("bookingForm");d&&d.addEventListener("submit",async function(e){e.preventDefault();var e=document.getElementById("clientName").value.trim(),t=document.getElementById("clientPhone").value.trim(),n=document.getElementById("clientEmail").value.trim(),a=document.getElementById("carModel").value.trim(),r=document.getElementById("selectedService").value,o=document.getElementById("bookingDate").value,i=document.getElementById("bookingTime").value,s=document.getElementById("comments").value.trim(),l=new Date,c=(l.setHours(0,0,0,0),new Date(o));if(c<l)window.showNotification("Нельзя записаться на прошедшую дату");else if(i)if(e&&t&&a&&r&&o&&i){c=services[r];if(c){l=(c.parts||[]).reduce((e,t)=>e+(parts[t]?parts[t].price:0),0),c=c.price+l,l={clientName:e,clientPhone:t,clientEmail:n,carModel:a,service:r,date:o,time:i,comments:s,total:c};try{await submitBooking(l),d.reset(),window.showNotification(`Вы записаны на ${o} в ${i}. Стоимость: ${c} ₽`),displayUpcomingBookings(),updateAdmin()}catch(e){alert("Ошибка отправки записи. Попробуйте позже."),console.error(e)}}else window.showNotification("Выбранная услуга не найдена")}else window.showNotification("Пожалуйста, заполните все обязательные поля");else window.showNotification("Выберите время")});var e=document.getElementById("btnShowAllRecords"),e=(e&&e.addEventListener("click",()=>{updateAdmin();var e=document.getElementById("admin");e&&e.scrollIntoView({behavior:"smooth"})}),document.getElementById("btnClearRecords"));e&&e.addEventListener("click",async()=>{await clearAllRecords(),updateAdmin(),displayUpcomingBookings(),window.showNotification("Все записи удалены")});let t=document.getElementById("searchInput"),n=document.getElementById("typeFilter"),a=document.getElementById("priceFrom"),r=document.getElementById("priceTo");var e=document.getElementById("resetFilters"),e=(t&&t.addEventListener("input",filterAndRender),n&&n.addEventListener("change",filterAndRender),a&&a.addEventListener("input",filterAndRender),r&&r.addEventListener("input",filterAndRender),e&&e.addEventListener("click",()=>{t&&(t.value=""),n&&(n.value="all"),a&&(a.value=""),r&&(r.value=""),filterAndRender()}),console.log("Инициализирую приложение..."),await loadCatalog()),e=(applyCatalogData(e),await displayUpcomingBookings(),await updateAdmin(),(e=new Date).getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")),o=document.getElementById("bookingDate"),i=document.getElementById("bookingTime");if(o&&(o.min=e),i){i.innerHTML='<option value="">Выберите время</option>';for(let e=9;e<=17;e++)for(var s of["00","30"]){var s=e.toString().padStart(2,"0")+":"+s,l=document.createElement("option");l.value=s,l.textContent=s,i.appendChild(l)}}console.log("Приложение готово!")});let BTN_RESET_DELAY=2e3;function getCurrentUserId(){var e=localStorage.getItem("currentUser");if(e)try{var t=JSON.parse(e);return"user"===t.role?t.id:null}catch(e){}return null}async function loadCart(){var e=getCurrentUserId();if(!e)return[];try{var t=await fetch("/api/cart/"+e);if(t.ok)return await t.json();throw new Error("Не удалось загрузить корзину")}catch(e){return console.warn("Ошибка загрузки корзины:",e),[]}}async function saveCart(e){var t=getCurrentUserId();if(t)try{await fetch("/api/cart/"+t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}catch(e){console.error("Ошибка сохранения корзины:",e),alert("Не удалось сохранить корзину")}}function updateCartCountHeader(e){"function"==typeof window.updateCartCountHeader&&$("#cartCount").text(e)}async function addToCart(t){var e=await loadCart(),n=e.find(e=>e.type===t.type&&e.name===t.name),n=(n?n.qty++:e.push({...t,qty:1}),await saveCart(e),e.reduce((e,t)=>e+t.qty,0));updateCartCountHeader(n)}function flashAddedButton(e){let t=e.text();e.addClass("added").text("Добавлено"),setTimeout(()=>e.removeClass("added").text(t),BTN_RESET_DELAY)}if($(document).on("click",".btn-to-cart, .btn-select-service",async function(e){e.preventDefault();var e=$(this),t=e.hasClass("btn-select-service"),n=e.closest(".service-card, .part-card"),a=n.find("h3").text().trim(),r=parseInt((n.find(".price").text()||"").replace(/\D/g,"")||"0",10);let o=null;t||(n=n.find(".part-image img"),o=n.length?n.attr("src"):null),await addToCart({type:t?"service":"part",name:a,price:r,image:o}),flashAddedButton(e),t&&$("#selectedService").val(a)}),document.getElementById("cartApp")){let{createApp:e,ref:a,computed:r,onMounted:o}=Vue;function formatPrice(e){return(e||0).toLocaleString("ru-RU")+" ₽"}e({setup(){let t=a([]);var e=r(()=>t.value.reduce((e,t)=>e+t.price*t.qty,0));let n=async()=>{await saveCart(t.value),updateCartCountHeader(t.value.reduce((e,t)=>e+t.qty,0))};return o(async()=>{var e=await loadCart();t.value=e}),{cartItems:t,totalPrice:e,formatPrice:formatPrice,increaseItem:async e=>{t.value[e].qty++,await n()},decreaseItem:async e=>{1<t.value[e].qty?t.value[e].qty--:t.value.splice(e,1),await n()},removeItem:async e=>{t.value.splice(e,1),await n()},clearCart:async()=>{t.value=[],await n()}}}}).mount("#cartApp")}document.getElementById("orderItemsContainer")&&$(async function(){var e=await loadCart();if(0===e.length)$("#orderItemsContainer").html('<p class="empty-message">Ваш заказ пуст.</p>');else{let a=0,r=0,o=0,i=$("#orderItemsContainer");i.empty(),e.forEach(e=>{var t=e.price*e.qty;"part"===e.type?r+=t:o+=t,a+=t;let n="";e.image?n=`<img src="${e.image}" alt="${e.name}" class="order-item-image">`:"service"===e.type&&(n='<div class="order-item-icon">⚙️</div>');t=`
        <div class="order-item">
          ${n}
          <div class="item-info">
            <strong>${e.name}</strong>
            <div class="item-meta">${"service"===e.type?"Услуга":"Запчасть"} — ${e.price.toLocaleString("ru-RU")} ₽</div>
          </div>
          <div class="item-qty">×${e.qty}</div>
        </div>
      `;i.append(t)}),$("#sumPrice").text(o.toLocaleString("ru-RU")+" ₽"),$("#partsCost").text(r.toLocaleString("ru-RU")+" ₽"),$("#total").text(a.toLocaleString("ru-RU")+" ₽");e=e.reduce((e,t)=>e+t.qty,0);$("#cartCount").text(e),$("#cartCountHeader").text(e)}}),$(function(){let i="currentUser";function s(e){e.addClass("error").removeClass("valid")}function l(e){e.removeClass("error").addClass("valid")}function c(e){e.removeClass("error valid")}function d(e,t){e=$(e);t?e.text(t).show():e.hide().text("")}function m(e){let t=$("#notification");(t=t.length?t:$('<div id="notification"></div>').appendTo("body")).text(e).addClass("show"),setTimeout(()=>t.removeClass("show"),3e3)}function t(){var e=localStorage.getItem(i);return e?JSON.parse(e):null}function e(){localStorage.removeItem(i),location.reload()}function n(){var e=t();e?"admin"===e.role?$(".btn-to-cart, .btn-select-service").each(function(){$(this).removeClass("btn-to-cart btn-select-service").addClass("btn-delete-admin").text("Удалить").show()}):$(".btn-to-cart, .btn-select-service").show():$(".btn-to-cart, .btn-select-service").hide()}if($("#registerForm").on("submit",function(e){e.preventDefault();var e=$("#name"),t=$("#password"),n=$("#confirmPassword");let a=$("#email");var r=$("#terms");let o=!1;c(e),c(t),c(n),c(a),e.val().trim()?l(e):(s(e),o=!0),t.val().length<8?(s(t),o=!0):l(t),t.val()!==n.val()?(s(n),o=!0):l(n),a.val().includes("@")?l(a):(s(a),o=!0),r.is(":checked")?(r.removeClass("error"),r.closest(".form-checkbox").removeClass("error")):(o=!0,d("#regMessage","Необходимо принять условия использования"),r.addClass("error"),r.closest(".form-checkbox").addClass("error")),o?d("#regMessage","Проверьте поля формы"):$.ajax({url:"/api/register",method:"POST",contentType:"application/json",data:JSON.stringify({name:e.val().trim(),email:a.val().trim(),password:t.val(),carModel:$("#carModel").val().trim(),engineVolume:parseFloat($("#engineVolume").val())}),success:function(e){localStorage.setItem(i,JSON.stringify(e.user)),m("Регистрация прошла успешно!"),setTimeout(()=>window.location.href="index.html",1500)},error:function(e){d("#regMessage",e.responseJSON?.error||"Ошибка регистрации"),s(a)}})}),$("#loginForm").on("submit",function(e){e.preventDefault();let t=$("#loginEmail");e=$("#loginPassword");c(t),c(e);let n=!1;t.val().includes("@")?l(t):(s(t),d("#loginMessage","Некорректный email"),n=!0),e.val().length<8?(s(e),d("#loginMessage","Пароль должен быть не менее 8 символов"),n=!0):l(e),n||$.ajax({url:"/api/login",method:"POST",contentType:"application/json",data:JSON.stringify({email:t.val(),password:e.val()}),success:function(e){localStorage.setItem(i,JSON.stringify(e.user)),m("Вход выполнен!"),setTimeout(()=>window.location.href="index.html",1500)},error:function(e){d("#loginMessage",e.responseJSON?.error||"Ошибка входа"),s(t)}})}),new MutationObserver(function(e){for(var t of e)if("childList"===t.type&&0<$(".service-card, .part-card").length){n();break}}).observe(document.body,{childList:!0,subtree:!0}),setTimeout(n,100),$(document).on("click",".btn-delete-admin",function(){let e=$(this).closest(".service-card, .part-card");var t=e.find("h3").text().trim(),n=e.hasClass("service-card");$.ajax({url:`/api/items/${n?"service":"part"}/`+encodeURIComponent(t),method:"DELETE",success:function(){e.fadeOut(300,function(){$(this).remove()})},error:function(){alert("Ошибка удаления карточки")}})}),"cart.html"===location.pathname.split("/").pop()){var a=t();if(!a||"user"!==a.role)return void(window.location.href="login.html")}var r,a=t(),o=location.pathname.includes("login")||location.pathname.includes("reg");if($("body").removeClass("is-auth is-user is-admin"),a&&("admin"===a.role?$("body").addClass("is-admin"):$("body").addClass("is-user")),$("#authButtons, #userInfo, .btn-cart").hide(),$("#adminNav").remove(),a?($("#userInfo").show(),$("#userName").text(a.name),$("#userRole").text("admin"===a.role?"(Администратор)":"(Пользователь)"),$("#logoutBtn").off("click").on("click",e),a.car&&a.car.model&&a.car.engineVolume?(r=`${a.car.model} • ${a.car.engineVolume} л`,$("#userCarInfo").text(r).show()):$("#userCarInfo").hide(),("admin"===a.role?($(".btn-cart").hide(),$("#booking").hide(),$("#nav-booking").hide(),$(".btn-secondary").hide(),$("header nav ul").append('<li id="adminNav"><a href="index.html#admin">Администрирование</a></li>'),$("#admin")):($(".btn-cart").show(),$("#admin").hide(),$("#booking").show(),$("#nav-booking").show(),$(".btn-secondary"))).show()):($("#authButtons").show(),$("#admin").hide(),$("#booking").hide(),$("#nav-booking").hide(),$(".btn-secondary").hide(),o||$(".btn-cart").hide()),document.getElementById("btnAddItem")&&document.getElementById("addItemModal")){let t=document.getElementById("addItemModal"),e=document.getElementById("addItemForm"),n=document.getElementById("itemType"),a=document.getElementById("serviceParts"),r=document.getElementById("partImage");n.addEventListener("change",()=>{"service"===n.value?(a.style.display="block",r.style.display="none"):(a.style.display="none",r.style.display="block")}),document.getElementById("btnAddItem").addEventListener("click",()=>{e.reset(),n.dispatchEvent(new Event("change")),t.style.display="block"}),document.getElementById("closeModal").addEventListener("click",()=>{t.style.display="none"}),e.addEventListener("submit",async e=>{e.preventDefault();e={type:n.value,name:document.getElementById("itemName").value.trim(),price:document.getElementById("itemPrice").value,description:document.getElementById("itemDesc").value.trim(),parts:document.getElementById("itemParts")?.value||"",image:document.getElementById("itemImage")?.value.trim()||""};try{if(!(await fetch("/api/items",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).ok)throw new Error("Ошибка добавления");m("Товар успешно добавлен!"),t.style.display="none",applyCatalogData(await loadCatalog())}catch(e){m("Не удалось добавить товар: "+(e.message||"ошибка"))}})}"function"==typeof window.updateCartCountHeader&&(r=t())&&"user"===r.role&&fetch("/api/cart/"+r.id).then(e=>e.json()).then(e=>{e=e.reduce((e,t)=>e+t.qty,0);$("#cartCount").text(e)}).catch(()=>$("#cartCount").text("0")),$(document).on("input","input",function(){$(this).hasClass("error")&&$(this).removeClass("error")}),window.showNotification=m});